import jsPDF from 'jspdf';
import type { SubCategory, Snippet } from '../lib/cheatsheets';

export async function generateCheatsheetPDF(
  categoryName: string,
  subCategory: SubCategory
) {
  const pdf = new jsPDF({
    orientation: 'portrait',
    unit: 'mm',
    format: 'a4',
  });

  const pageWidth = 210; // A4 width in mm
  const pageHeight = 297; // A4 height in mm
  const margin = 20;
  const contentWidth = pageWidth - 2 * margin;

  // Page 1: Cover Page
  addCoverPage(pdf, categoryName, subCategory.name, pageWidth, pageHeight);

  // Middle Pages: Content
  pdf.addPage();
  await addContentPages(pdf, subCategory, margin, contentWidth, pageHeight);

  // Last Page: Advertisement
  pdf.addPage();
  addAdvertisementPage(pdf, pageWidth, pageHeight);

  // Download the PDF
  pdf.save(`${categoryName}-${subCategory.name}-Cheatsheet.pdf`);
}

function addCoverPage(
  pdf: jsPDF,
  categoryName: string,
  subCategoryName: string,
  pageWidth: number,
  pageHeight: number
) {
  // Background color
  pdf.setFillColor(59, 130, 246); // Blue
  pdf.rect(0, 0, pageWidth, pageHeight, 'F');

  // CheatJS Logo/Title
  pdf.setTextColor(255, 255, 255);
  pdf.setFontSize(48);
  pdf.setFont('helvetica', 'bold');
  pdf.text('CheatJS', pageWidth / 2, 80, { align: 'center' });

  // Topic Name
  pdf.setFontSize(36);
  pdf.setFont('helvetica', 'normal');
  pdf.text(categoryName, pageWidth / 2, 120, { align: 'center' });

  // SubCategory Name
  pdf.setFontSize(28);
  pdf.text(subCategoryName, pageWidth / 2, 145, { align: 'center' });

  // Subtitle
  pdf.setFontSize(14);
  pdf.setFont('helvetica', 'italic');
  pdf.text('Your Quick Reference Guide', pageWidth / 2, 170, { align: 'center' });

  // Footer
  pdf.setFontSize(10);
  pdf.text('Generated by CheatJS.com', pageWidth / 2, 270, { align: 'center' });
}

async function addContentPages(
  pdf: jsPDF,
  subCategory: SubCategory,
  margin: number,
  contentWidth: number,
  pageHeight: number
) {
  let yPosition = margin;
  const lineHeight = 7;
  const maxY = pageHeight - margin;

  // Helper function to check if we need a new page
  const checkNewPage = (requiredSpace: number): boolean => {
    if (yPosition + requiredSpace > maxY) {
      pdf.addPage();
      yPosition = margin;
      return true;
    }
    return false;
  };

  // Process sections if they exist
  if (subCategory.sections) {
    for (const section of subCategory.sections) {
      // Section heading
      checkNewPage(15);
      pdf.setFontSize(18);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(59, 130, 246);
      pdf.text(section.heading, margin, yPosition);
      yPosition += lineHeight + 3;

      // Process snippets in section
      for (const snippet of section.snippets) {
        yPosition = addSnippetToPDF(pdf, snippet, margin, contentWidth, yPosition, maxY, lineHeight, checkNewPage);
      }
    }
  }

  // Process direct snippets if they exist
  if (subCategory.snippets) {
    for (const snippet of subCategory.snippets) {
      yPosition = addSnippetToPDF(pdf, snippet, margin, contentWidth, yPosition, maxY, lineHeight, checkNewPage);
    }
  }
}

function addSnippetToPDF(
  pdf: jsPDF,
  snippet: Snippet,
  margin: number,
  contentWidth: number,
  startY: number,
  maxY: number,
  lineHeight: number,
  checkNewPage: (space: number) => boolean
): number {
  let yPosition = startY;

  // Check if we need a new page for the snippet
  checkNewPage(30);

  // Title
  pdf.setFontSize(14);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(0, 0, 0);
  pdf.text(snippet.title, margin, yPosition);
  yPosition += lineHeight;

  // Description
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(80, 80, 80);
  const descLines = pdf.splitTextToSize(snippet.description, contentWidth);
  pdf.text(descLines, margin, yPosition);
  yPosition += descLines.length * 5 + 3;

  // Code block
  if (snippet.code) {
    checkNewPage(40);
    
    // Code background
    pdf.setFillColor(245, 245, 245);
    const codeHeight = Math.min(60, snippet.code.split('\n').length * 4);
    pdf.rect(margin, yPosition - 3, contentWidth, codeHeight, 'F');

    // Code text
    pdf.setFontSize(8);
    pdf.setFont('courier', 'normal');
    pdf.setTextColor(0, 0, 0);
    
    const codeLines = snippet.code.split('\n').slice(0, 15); // Limit lines
    let codeY = yPosition;
    
    for (const line of codeLines) {
      if (codeY + 4 > maxY) break;
      const truncatedLine = line.substring(0, 90); // Limit line length
      pdf.text(truncatedLine, margin + 2, codeY);
      codeY += 4;
    }
    
    yPosition = codeY + 5;
  }

  // Add spacing between snippets
  yPosition += 5;
  
  // Check if we need a new page after this snippet
  if (yPosition > maxY - 30) {
    pdf.addPage();
    yPosition = margin;
  }

  return yPosition;
}

function addAdvertisementPage(
  pdf: jsPDF,
  pageWidth: number,
  pageHeight: number
) {
  const margin = 20;

  // Background gradient effect (using rectangles)
  pdf.setFillColor(249, 250, 251);
  pdf.rect(0, 0, pageWidth, pageHeight, 'F');

  // Main heading
  pdf.setTextColor(59, 130, 246);
  pdf.setFontSize(32);
  pdf.setFont('helvetica', 'bold');
  pdf.text('CheatJS', pageWidth / 2, 60, { align: 'center' });

  // Tagline
  pdf.setTextColor(0, 0, 0);
  pdf.setFontSize(18);
  pdf.setFont('helvetica', 'normal');
  pdf.text('Your Ultimate Developer Cheatsheet', pageWidth / 2, 80, { align: 'center' });

  // Features
  pdf.setFontSize(12);
  pdf.setTextColor(60, 60, 60);
  const features = [
    '✓ React, Next.js, and Frontend Concepts',
    '✓ Data Structures & Algorithms',
    '✓ Interactive Code Examples',
    '✓ Beginner to Advanced Topics',
    '✓ Always Free & Up-to-date',
  ];

  let yPos = 110;
  features.forEach((feature) => {
    pdf.text(feature, pageWidth / 2, yPos, { align: 'center' });
    yPos += 12;
  });

  // Call to action
  pdf.setFontSize(16);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(59, 130, 246);
  pdf.text('Visit us at:', pageWidth / 2, 190, { align: 'center' });

  pdf.setFontSize(20);
  pdf.text('CheatJS.com', pageWidth / 2, 205, { align: 'center' });

  // Social/Contact
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(100, 100, 100);
  pdf.text('Learn faster. Code better. Build amazing things.', pageWidth / 2, 230, { align: 'center' });

  // Footer
  pdf.setFontSize(9);
  pdf.setTextColor(150, 150, 150);
  pdf.text('© 2024 CheatJS. All rights reserved.', pageWidth / 2, 280, { align: 'center' });
}
